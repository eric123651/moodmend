<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MoodMend">
    <meta name="theme-color" content="#6A82FB">
    <meta name="description" content="MoodMend 幫助你記錄和管理情緒，提供个性化的情緒調整方案">
    <!-- PWA配置 -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.svg">
    <link rel="mask-icon" href="icon-192x192.svg" color="#6A82FB">
    <link rel="shortcut icon" href="icon-192x192.svg">
    <!-- 预加载核心资源 -->
    <title>MoodMend</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 基础重置和APP样式 */
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #6A82FB 0%, #FC5C7D 100%); 
            min-height: 100vh; 
            margin: 0; 
            padding: 0; 
            color: #333;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        /* 功能菜单样式 */
        .menu-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .menu-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #6A82FB;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(106, 130, 251, 0.4);
            margin: 0;
            padding: 0;
        }
        .menu-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            width: 200px;
            display: none;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .menu-dropdown button {
            width: 100%;
            padding: 16px 20px;
            border: none;
            background: white;
            color: #333;
            text-align: left;
            font-size: 16px;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f0f0f0;
        }
        .menu-dropdown button:last-child {
            border-bottom: none;
        }
        .menu-dropdown button:hover, .menu-dropdown button:active {
            background: #f8f9fa;
            transform: none;
        }
        .menu-dropdown.show {
            display: block;
        }
        .page { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100vh; 
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); 
            box-sizing: border-box; 
            overflow-y: auto;
        }
        .page.active { display: block; }
        .container { 
            width: 100%; 
            max-width: 100%; 
            margin: 0; 
            background: rgba(255,255,255,0.95); 
            border-radius: 0; 
            min-height: 100%; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        h1 { text-align: center; color: #6A82FB; font-size: 24px; margin: 20px 0; }
        input, select { 
            width: 100%; 
            padding: 16px; 
            margin: 12px 0; 
            border: 2px solid #FC5C7D; 
            border-radius: 12px; 
            box-sizing: border-box; 
            font-size: 16px; /* 防止iOS缩放 */
            appearance: none;
            -webkit-appearance: none;
        }
        button { 
            background: #FC5C7D; 
            color: white; 
            border: none; 
            padding: 16px 24px; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: 600;
            cursor: pointer; 
            transition: transform 0.2s, background-color 0.2s;
            width: 100%; 
            margin: 12px 0; 
            box-shadow: 0 4px 12px rgba(252, 92, 125, 0.3);
        }
        button:hover, button:active { 
            transform: scale(1.02); 
            background-color: #ff4a69; 
        }
        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 20px; 
            margin: 15px 0; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); 
        }
        .emotion-badge { 
            display: inline-block; 
            padding: 8px 16px; 
            border-radius: 25px; 
            color: white; 
            font-weight: bold; 
            margin: 5px; 
            font-size: 14px;
        }
        .anxious { background: #FF6B6B; color: white; } 
        .sad { background: #4ECDC4; color: white; } 
        .neutral { background: #45B7D1; color: white; } 
        .happy { background: #96CEB4; color: white; } 
        .angry { background: #FFEAA7; color: #333; }
        /* To-Do List样式 */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 16px;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        .todo-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .todo-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            cursor: pointer;
            border: 2px solid #6A82FB;
            border-radius: 8px;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
            flex-shrink: 0;
        }
        .todo-checkbox:checked {
            background: #6A82FB;
            border-color: #6A82FB;
        }
        .todo-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .todo-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
            transition: opacity 0.2s ease;
        }
        .todo-checkbox:checked + .todo-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .log-entry { 
            background: #f0f8ff; 
            padding: 16px; 
            border-radius: 16px; 
            margin: 10px 0; 
            line-height: 1.6;
        }
        .filter-bar { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .filter-bar select, .filter-bar input { 
            flex: 1; 
            min-width: 0; 
        }
        #logChart { max-height: 200px; margin: 20px 0; }
        /* 底部导航栏 - 模拟APP底部标签栏 */
        .nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            gap: 0; 
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            padding: 12px 0;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        .nav button { 
            flex: 1; 
            margin: 0 8px;
            border-radius: 16px;
            font-size: 14px;
            padding: 14px 10px;
            box-shadow: none;
        }
        .stats { 
            text-align: center; 
            margin: 20px 0; 
            font-weight: bold; 
            color: #6A82FB; 
            font-size: 16px;
            padding: 12px;
            background: rgba(106, 130, 251, 0.1);
            border-radius: 16px;
        }
    </style>
</head>
<body>
    <!-- 頁1: 登錄 -->
    <div id="page1" class="page active">
        <div class="container">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="icon-moodmend.svg" alt="MoodMend Logo" width="160" height="160" style="max-width: 80%;">
            </div>
            <h1>MoodMend 歡迎</h1>
            <div class="card">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="login()">登錄</button>
                <button onclick="switchPage('pageRegister')" style="background-color: #6A82FB; box-shadow: 0 4px 12px rgba(106, 130, 251, 0.3);">註冊新帳號</button>
                <p style="text-align: center; font-size: 12px;">Demo: 用 test@test.com / 123 登入</p>
            </div>
        </div>
    </div>
    
    <!-- 頁5: 註冊 -->
    <div id="pageRegister" class="page">
        <div class="container">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="icon-moodmend.svg" alt="MoodMend Logo" width="160" height="160" style="max-width: 80%;">
            </div>
            <h1>創建新帳號</h1>
            <div class="card">
                <input type="text" id="registerUserName" placeholder="用户名 (2-20个字符)">
                <input type="email" id="registerEmail" placeholder="Email">
                <input type="password" id="registerPassword" placeholder="密碼 (至少6位)">
                <input type="password" id="confirmPassword" placeholder="確認密碼">
                <button onclick="register()">註冊</button>
                <button onclick="switchPage('page1')" style="background-color: #666; box-shadow: 0 4px 12px rgba(102, 102, 102, 0.3);">返回登錄</button>
            </div>
        </div>
    </div>

    <!-- 頁2: 歡迎頁面 -->
    <div id="pageWelcome" class="page">
        <div class="container">
            <!-- 功能菜单 -->
            <div class="menu-container">
                <button id="menuButtonWelcome" class="menu-button" onclick="toggleMenu('menuButtonWelcome')">☰</button>
                <div id="menuWelcome" class="menu-dropdown">
                    <button onclick="switchPage('page2')">💭 心情記錄</button>
                    <button onclick="switchPage('page3')">📊 查看紀錄</button>
                    <button onclick="logout()">👤 登出</button>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="icon-moodmend.svg" alt="MoodMend Logo" width="120" height="120" style="max-width: 60%;">
            </div>
            <h1>歡迎來到 MoodMend</h1>
            <p id="welcomeMessage" class="welcome-message" style="text-align: center; font-size: 18px; color: #6A82FB; margin-bottom: 20px;"></p>
            <div class="card" style="text-align: center; padding: 30px 15px; margin-top: 40px;">
                <p style="font-size: 18px; margin-bottom: 30px; font-weight: 500;">「每一種情緒都值得被理解和關照」</p>
                <p style="margin-bottom: 40px; line-height: 1.6; font-size: 16px;">在這裡，我們將一起探索你的情緒世界，提供專屬的調適方案，幫助你度過每一個心情時刻。</p>
                <button onclick="switchPage('page2')" style="margin-top: 20px; font-size: 18px; padding: 16px;">開始調適之旅</button>
            </div>
            <div style="text-align: center; margin-top: 40px; padding: 0 20px;">
                <p style="color: #666; font-size: 14px;">今天，你想如何照顧自己的心情？</p>
            </div>
        </div>
    </div>

    <!-- 頁3: 主要互動 -->
    <div id="page2" class="page">
        <div class="container">
            <!-- 功能菜单 -->
            <div class="menu-container">
                <button id="menuButton2" class="menu-button" onclick="toggleMenu('menuButton2')">☰</button>
                <div id="menu2" class="menu-dropdown">
                    <button onclick="switchPage('pageWelcome')">🏠 回到歡迎頁</button>
                    <button onclick="switchPage('page3')">📊 查看紀錄</button>
                    <button onclick="logout()">👤 登出</button>
                </div>
            </div>
            <h1>今天的心情？</h1>
            <input type="text" id="emotionInput" placeholder="例如：我感到焦慮">
            <button onclick="processEmotion()">開始調節</button>
            <div id="packageCard" class="card" style="display: none;"></div>
            <div style="display: none;" id="taskSection">
                <h3 style="color: #6A82FB; margin-top: 30px; margin-bottom: 20px;">今天的任務</h3>
                <div class="todo-item">
                    <input type="checkbox" id="taskComplete" class="todo-checkbox" onchange="checkCompletion()">
                    <span class="todo-text" id="taskText">正在加載任務...</span>
                </div>
                <button onclick="showNFT()" id="nftButton" style="margin-top: 20px;">生成徽章</button>
            </div>
            <!-- 移除底部的查看Log按钮，功能已整合到顶部菜单 -->
        </div>
    </div>

    <!-- 頁4: Log紀錄 -->
    <div id="page3" class="page">
        <div class="container">
            <!-- 功能菜单 -->
            <div class="menu-container">
                <button id="menuButton3" class="menu-button" onclick="toggleMenu('menuButton3')">☰</button>
                <div id="menu3" class="menu-dropdown">
                    <button onclick="switchPage('pageWelcome')">🏠 回到歡迎頁</button>
                    <button onclick="switchPage('page2')">💭 心情記錄</button>
                    <button onclick="logout()">👤 登出</button>
                </div>
            </div>
            <h1>我的療癒紀錄</h1>
            <div class="filter-bar">
                <select id="emotionFilter" style="flex: 1;">
                    <option value="">所有情緒</option>
                    <option value="anxious">焦慮</option>
                    <option value="sad">傷心</option>
                    <option value="neutral">平靜</option>
                    <option value="happy">快樂</option>
                    <option value="angry">生氣</option>
                </select>
                <input type="date" id="dateFilter" style="flex: 1;">
                <button onclick="filterLogs()" style="flex-shrink: 0; min-width: 80px;">過濾</button>
            </div>
            <div class="stats" id="stats">本週完成率：0% | 轉移成就：0</div>
            <canvas id="logChart"></canvas>
            <div id="logSection"></div>
            <!-- 移除nav中的返回互動按鈕，僅留空間若未來加新CTA -->
        </div>
    </div>

    <script>
        // 全局变量定义 - 确保在所有使用前初始化
        window.currentUser = null;
        let currentPackage = null;
        let userLogs = [];
        
        // 修复iOS Safari中状态栏覆盖问题
        if (/(iPhone|iPad|iPod)/i.test(navigator.userAgent)) {
            document.documentElement.style.paddingTop = env(safe-area-inset-top) + 'px';
        }

        // 功能菜单切换
        function toggleMenu(buttonId) {
            // 关闭所有其他菜单
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // 切换当前菜单
            const button = document.getElementById(buttonId);
            const menuId = buttonId.replace('Button', '');
            const menu = document.getElementById(menuId);
            menu.classList.toggle('show');
        }
        
        // 点击页面其他地方关闭菜单
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-container')) {
                document.querySelectorAll('.menu-dropdown').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // 頁面切換 - 添加平滑过渡
        function switchPage(pageId) {
            // 先关闭所有菜单
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // 显示目标页面
            document.getElementById(pageId).classList.add('active');
            
            // 重置滚动位置
            document.getElementById(pageId).scrollTop = 0;
            
            // 如果是欢迎页面，更新用户名显示
            if (pageId === 'pageWelcome' && currentUser) {
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (welcomeMessage && currentUser.user_name) {
                    welcomeMessage.textContent = `嗨，${currentUser.user_name}！`;
                }
            }
            
            // 如果切换到日志页，加载数据
            if (pageId === 'page3') {
                loadLogs();
            }
        }

        // 显示加载中 - 改进加载动画
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div style="text-align: center; padding: 20px; color: #6A82FB;"><div style="display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(106, 130, 251, 0.3); border-radius: 50%; border-top-color: #6A82FB; animation: spin 1s ease-in-out infinite;"></div><p style="margin-top: 10px;">加載中...</p></div>';
        }
        
        // 添加旋转动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // 显示错误信息 - 使用更友好的提示方式
        function showError(message) {
            // 移动端更友好的提示
            const errorCard = document.createElement('div');
            errorCard.className = 'card';
            errorCard.style.backgroundColor = '#ffebee';
            errorCard.style.color = '#c62828';
            errorCard.style.position = 'fixed';
            errorCard.style.bottom = '100px';
            errorCard.style.left = '50%';
            errorCard.style.transform = 'translateX(-50%)';
            errorCard.style.zIndex = '1000';
            errorCard.style.padding = '15px 20px';
            errorCard.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';
            errorCard.textContent = '錯誤：' + message;
            
            document.body.appendChild(errorCard);
            
            // 3秒后自动消失
            setTimeout(() => {
                errorCard.style.opacity = '0';
                errorCard.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(errorCard);
                }, 500);
            }, 3000);
        }

        // 登錄
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                return alert('請填寫完整的登錄資訊');
            }
            
            try {
                // 显示加载状态
                const loginButton = document.querySelector('#page1 button');
                const originalText = loginButton.textContent;
                loginButton.textContent = '登錄中...';
                loginButton.disabled = true;
                
                console.log('正在发送登录请求:', email);
                const response = await fetch('http://localhost:5000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                console.log('登录请求响应状态:', response.status);
                const data = await response.json();
                console.log('登录响应数据:', data);
                
                if (data.success) {
                    // 保存用户信息（包含用户名）
                    window.currentUser = {
                        email: data.email,
                        user_name: data.user_name
                    };
                    localStorage.setItem('user', JSON.stringify(window.currentUser));
                    // 清空输入框
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    alert('登錄成功！');
                    switchPage('pageWelcome');
                } else {
                    alert(data.message || '登錄失敗，請檢查帳號密碼');
                }
            } catch (error) {
                console.error('登錄错误:', error);
                showError('登錄失敗，請確認後端服務已啟動');
            } finally {
                // 恢复按钮状态
                const loginButton = document.querySelector('#page1 button');
                loginButton.textContent = '登錄';
                loginButton.disabled = false;
            }
        }
        
        // 註冊
        async function register() {
            const user_name = document.getElementById('registerUserName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // 表单验证
            if (!email || !password || !user_name) {
                return alert('請填寫完整的註冊資訊');
            }
            
            if (user_name.length < 2 || user_name.length > 20) {
                return alert('用户名长度应在2-20个字符之间');
            }
            
            if (password.length < 6) {
                return alert('密碼長度至少需要6位');
            }
            
            if (password !== confirmPassword) {
                return alert('兩次輸入的密碼不一致');
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, user_name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 註冊成功後自動登錄
                    currentUser = {
                        email: data.email,
                        user_name: data.user_name
                    };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    // 清空输入框
                    document.getElementById('registerUserName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    switchPage('pageWelcome');
                } else {
                    alert(data.message || '註冊失敗，請稍後重試');
                }
            } catch (error) {
                showError('註冊失敗，請確認後端服務已啟動');
            }
        }

        // 處理情緒
        async function processEmotion() {
            const input = document.getElementById('emotionInput').value;
            if (!input) return alert('請輸入');
            
            try {
                const taskCompleted = document.getElementById('taskComplete')?.checked || false;
                
                showLoading('packageCard');
                
                // 检查网络连接
                if (!navigator.onLine) {
                    // 离线模式 - 提示用户
                    showError('当前处于离线状态，请检查网络连接后重试。');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/process-emotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        input, 
                        email: window.currentUser?.email || window.currentUser,
                        task_completed: taskCompleted
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentPackage = data;
                    const pkg = data.package;
                    
                    document.getElementById('packageCard').innerHTML = `
                        <h3><span class="emotion-badge ${pkg.color}">${data.emotion}</span></h3>
                        <p><strong>技巧：</strong>${pkg.tips}</p>
                        <p><strong>建議：</strong>${pkg.advice}</p>
                        <p><small>${pkg.resources}</small></p>
                    `;
                    // 更新任务文本
                    document.getElementById('taskText').textContent = pkg.daily_task;
                    document.getElementById('packageCard').style.display = 'block';
                    document.getElementById('taskSection').style.display = 'block';
                } else {
                    alert(data.message);
                }
            } catch (error) {
                showError('處理情緒失敗');
            }
        }

        // 检查任务完成状态，启用/禁用生成徽章按钮
        function checkCompletion() {
            const completed = document.getElementById('taskComplete').checked;
            const nftButton = document.getElementById('nftButton');
            
            if (completed) {
                nftButton.style.backgroundColor = '#4CAF50';
                nftButton.style.boxShadow = '0 4px 12px rgba(76, 175, 80, 0.3)';
            } else {
                nftButton.style.backgroundColor = '#FC5C7D';
                nftButton.style.boxShadow = '0 4px 12px rgba(252, 92, 125, 0.3)';
            }
        }

        // 显示徽章并保存日志
        async function showNFT() {
            if (!currentPackage) return;
            
            const completed = document.getElementById('taskComplete').checked;
            const badge = currentPackage.nft;
            
            // 移动端友好的提示
            const notification = document.createElement('div');
            notification.className = 'card';
            notification.style.backgroundColor = '#e8f5e9';
            notification.style.color = '#2e7d32';
            notification.style.position = 'fixed';
            notification.style.top = '50%';
            notification.style.left = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.zIndex = '1000';
            notification.style.padding = '20px';
            notification.style.boxShadow = '0 8px 30px rgba(0,0,0,0.3)';
            notification.style.textAlign = 'center';
            notification.innerHTML = `<h3 style="margin-top: 0;">🏆 恭喜！</h3><p style="font-size: 18px; margin-bottom: 20px;">${badge}</p>`;
            
            const okButton = document.createElement('button');
            okButton.textContent = '太棒了！';
            okButton.style.maxWidth = '200px';
            okButton.style.margin = '0 auto';
            okButton.style.display = 'block';
            
            document.body.appendChild(notification);
            notification.appendChild(okButton);
            
            // 等待用户点击确认
            await new Promise(resolve => {
                okButton.onclick = () => {
                    document.body.removeChild(notification);
                    resolve();
                };
            });
            
            // 准备日志数据
            const logData = {
                email: window.currentUser?.email || window.currentUser,
                emotion: currentPackage.emotion,
                task: currentPackage.package.daily_task,
                nft: badge,
                completed: completed,
                timestamp: new Date().toISOString()
            };
            
            try {
                // 检查网络连接
                if (navigator.onLine) {
                    // 在线模式 - 直接保存到服务器
                    const response = await fetch('http://localhost:5000/api/add-log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(logData)
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        // 保存失败，尝试保存到本地
                        saveLogToOffline(logData);
                        showError('保存到服务器失败，记录已保存到本地。');
                    }
                } else {
                    // 离线模式 - 保存到本地
                    saveLogToOffline(logData);
                    showError('当前处于离线状态，记录已保存，将在网络恢复后同步。');
                    
                    // 注册后台同步
                    if ('serviceWorker' in navigator && 'SyncManager' in window) {
                        const sw = await navigator.serviceWorker.ready;
                        try {
                            await sw.sync.register('sync-logs');
                        } catch (err) {
                            console.error('后台同步注册失败:', err);
                        }
                    }
                }
                
                // 重置界面
                document.getElementById('emotionInput').value = '';
                document.getElementById('taskComplete').checked = false;
                document.getElementById('taskText').textContent = '正在加載任務...';
                const nftButton = document.getElementById('nftButton');
                nftButton.style.backgroundColor = '#FC5C7D';
                nftButton.style.boxShadow = '0 4px 12px rgba(252, 92, 125, 0.3)';
                document.getElementById('packageCard').style.display = 'none';
                document.getElementById('taskSection').style.display = 'none';
                currentPackage = null;
                
                switchPage('page3');
            } catch (error) {
                // 保存失败，尝试保存到本地
                saveLogToOffline(logData);
                showError('保存日誌失敗，已尝试保存到本地。');
            }
        }

        // 加載日誌
        async function loadLogs(page = 1) {
            try {
                showLoading('logSection');
                
                const emotionFilter = document.getElementById('emotionFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;
                const limit = 50; // 每页显示50条记录
                const offset = (page - 1) * limit; // 计算偏移量
                
                let url = `http://localhost:5000/api/get-logs?email=${encodeURIComponent(window.currentUser?.email || window.currentUser)}&limit=${limit}&offset=${offset}`;
                if (emotionFilter) url += `&emotion=${encodeURIComponent(emotionFilter)}`;
                if (dateFilter) url += `&date=${encodeURIComponent(dateFilter)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    userLogs = data.logs;
                    const totalPages = Math.ceil(data.total / limit);
                    renderLogs(totalPages, page, data.total);
                    updateStats();
                }
            } catch (error) {
                showError('加載日誌失敗');
            }
        }

        // 渲染日誌
        function renderLogs(totalPages, currentPage, totalLogs) {
            const section = document.getElementById('logSection');
            section.innerHTML = '';
            
            // 显示日志总数
            const logCount = document.createElement('div');
            logCount.className = 'log-count';
            logCount.innerHTML = `<p style="text-align: center; color: #666; margin-bottom: 15px;">共 ${totalLogs} 條記錄</p>`;
            section.appendChild(logCount);
            
            if (userLogs.length === 0) {
                section.innerHTML += '<p style="text-align: center; color: #666;">此頁面沒有記錄</p>';
            } else {
                // 按時間倒序排列
                userLogs.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                userLogs.forEach(log => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    
                    // 情緒顏色映射
                    const emotionColors = {
                        'anxious': 'anxious',
                        'sad': 'sad',
                        'neutral': 'neutral',
                        'happy': 'happy',
                        'angry': 'angry'
                    };
                    
                    const colorClass = emotionColors[log.emotion] || 'neutral';
                    
                    entry.innerHTML = `
                        <strong>${log.time}:</strong> <span class="emotion-badge ${colorClass}">${log.emotion}</span>
                        | 任務: ${log.task} ${log.completed ? '✅' : ''} | 徽章: ${log.nft}
                    `;
                    section.appendChild(entry);
                });
                
                drawChart();
            }
            
            // 添加分页控件
            if (totalPages > 1) {
                const pagination = document.createElement('div');
                pagination.className = 'pagination';
                pagination.style.textAlign = 'center';
                pagination.style.marginTop = '20px';
                
                // 上一页按钮
                const prevButton = document.createElement('button');
                prevButton.textContent = '上一頁';
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => loadLogs(currentPage - 1);
                prevButton.className = 'btn';
                prevButton.style.marginRight = '10px';
                
                // 页码显示
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
                pageInfo.style.margin = '0 15px';
                pageInfo.style.lineHeight = '36px';
                
                // 下一页按钮
                const nextButton = document.createElement('button');
                nextButton.textContent = '下一頁';
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = () => loadLogs(currentPage + 1);
                nextButton.className = 'btn';
                nextButton.style.marginLeft = '10px';
                
                pagination.appendChild(prevButton);
                pagination.appendChild(pageInfo);
                pagination.appendChild(nextButton);
                section.appendChild(pagination);
            }
        }

        // 過濾日誌
        function filterLogs() {
            loadLogs(1); // 过滤时重置到第一页
        }

        // 更新統計信息
        async function updateStats() {
            try {
                // 首先检查网络状态
                if (!navigator.onLine) {
                    // 离线模式：尝试使用本地缓存的统计数据
                    const cachedStats = localStorage.getItem('cached_stats');
                    if (cachedStats) {
                        document.getElementById('stats').innerText = cachedStats;
                    } else {
                        document.getElementById('stats').innerText = '離線模式：無法更新統計';
                    }
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/get-stats?email=${encodeURIComponent(window.currentUser?.email || window.currentUser)}`);
                const data = await response.json();
                
                if (data.success) {
                    const statsText = `完成率：${data.completion_rate}% | 轉移成就：${data.transitions}`;
                    document.getElementById('stats').innerText = statsText;
                    // 缓存统计数据用于离线查看
                    localStorage.setItem('cached_stats', statsText);
                } else if (data.offline) {
                    // 显示离线提示
                    document.getElementById('stats').innerText = '離線模式：無法更新統計';
                }
            } catch (error) {
                console.error('更新統計失敗:', error);
                // 错误时尝试使用缓存或显示离线消息
                const cachedStats = localStorage.getItem('cached_stats');
                document.getElementById('stats').innerText = cachedStats || '離線模式：無法更新統計';
            }
        }

        // 绘制图表 - 优化移动端显示
        function drawChart() {
            const ctx = document.getElementById('logChart').getContext('2d');
            
            // 销毁旧图表
            if (window.emotionChart) {
                window.emotionChart.destroy();
            }
            
            // 计算情绪分布
            const emotionCounts = {
                'anxious': 0,
                'sad': 0,
                'neutral': 0,
                'happy': 0,
                'angry': 0
            };
            
            userLogs.forEach(log => {
                if (emotionCounts.hasOwnProperty(log.emotion)) {
                    emotionCounts[log.emotion]++;
                }
            });
            
            // 创建图表 - 优化移动端交互
            window.emotionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['焦慮', '傷心', '平靜', '快樂', '生氣'],
                    datasets: [{
                        data: [
                            emotionCounts.anxious,
                            emotionCounts.sad,
                            emotionCounts.neutral,
                            emotionCounts.happy,
                            emotionCounts.angry
                        ],
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value}次 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化 - 添加更多移动端适配和PWA支持
        function init() {
            console.log('开始初始化应用 - 增强PWA支持');
            
            // 禁用iOS双击缩放
            document.addEventListener('touchstart', function preventZoom(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // 存储初始触摸位置以检测双击
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function preventDoubleTapZoom(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
            
            // 显示加载指示器
            showLoadingIndicator();
            
            // 清除旧的Service Worker缓存（如果存在）
            if ('caches' in window) {
                console.log('尝试清除旧缓存...');
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        if (cacheName.startsWith('moodmend-') && !cacheName.includes('v3')) {
                            console.log('删除旧缓存:', cacheName);
                            caches.delete(cacheName);
                        }
                    });
                });
            }
            
            // 立即注册Service Worker，不再等待load事件
            registerServiceWorker();
            
            // 监听页面可见性变化，确保在页面重新可见时更新数据
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('页面变为可见，检查更新...');
                    // 如果已登录，刷新数据
                    if (window.currentUser) {
                        loadLogs(1);
                        updateStats();
                    }
                }
            });
            
            // 检查用户登录状态
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                console.log('检测到已保存的用户信息');
                try {
                    // 尝试解析用户对象
                    window.currentUser = JSON.parse(savedUser);
                } catch (e) {
                    // 兼容旧的存储方式
                    window.currentUser = {
                        email: savedUser,
                        user_name: '用户'
                    };
                    console.error('用户数据格式不匹配，使用默认值:', e);
                }
                console.log('用户信息:', window.currentUser);
                
                // 延迟切换页面，确保Service Worker有时间初始化
                setTimeout(() => {
                    switchPage('pageWelcome');
                    // 延迟加载数据，确保页面已渲染
                    setTimeout(() => {
                        console.log('开始加载用户数据...');
                        loadLogs(1);
                        updateStats();
                        hideLoadingIndicator();
                    }, 500);
                }, 500);
            } else {
                console.log('未检测到用户登录信息');
                hideLoadingIndicator();
            }
            
            // 初始化完成后，检查页面是否正常显示
            setTimeout(() => {
                console.log('初始化完成，检查页面状态...');
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    console.log('当前激活页面:', activePage.id, '，状态正常');
                } else {
                    console.log('页面初始化完成');
                }
            }, 2000);
        }

        // 登出函数
        function logout() {
            // 清除localStorage中的用户信息
            localStorage.removeItem('user');
            
            // 重置用户相关变量
            window.currentUser = null;
            currentPackage = null;
            userLogs = [];
            
            // 返回到登录页面
            switchPage('page1');
            
            // 显示登出成功提示
            alert('登出成功');
        }

        // 保存日志到离线存储
        function saveLogToOffline(logData) {
            try {
                let offlineLogs = JSON.parse(localStorage.getItem('offline_logs') || '[]');
                offlineLogs.push(logData);
                localStorage.setItem('offline_logs', JSON.stringify(offlineLogs));
                console.log('日志已保存到离线存储');
            } catch (error) {
                console.error('保存离线日志失败:', error);
            }
        }
        
        // 同步离线日志到服务器
        async function syncOfflineLogs() {
            try {
                // 确保在线状态
                if (!navigator.onLine) {
                    console.log('当前离线，无法同步日志');
                    return;
                }
                
                let offlineLogs = JSON.parse(localStorage.getItem('offline_logs') || '[]');
                
                if (offlineLogs.length === 0) return;
                
                // 过滤出当前用户的日志
                const userEmail = window.currentUser?.email || window.currentUser;
                const userLogs = offlineLogs.filter(log => log.email === userEmail);
                
                if (userLogs.length === 0) return;
                
                // 尝试同步每条日志
                const syncedLogs = [];
                
                for (const log of userLogs) {
                    try {
                        const response = await fetch('http://localhost:5000/api/add-log', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(log)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            syncedLogs.push(log);
                        }
                    } catch (error) {
                        console.error('同步单条日志失败:', error);
                    }
                }
                
                // 从离线存储中移除已同步的日志
                const remainingLogs = offlineLogs.filter(log => 
                    !syncedLogs.some(synced => 
                        synced.email === log.email && 
                        synced.timestamp === log.timestamp
                    )
                );
                
                localStorage.setItem('offline_logs', JSON.stringify(remainingLogs));
                
                // 通知Service Worker同步完成
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SYNC_COMPLETED',
                        data: { synced: syncedLogs.length }
                    });
                }
                
                console.log(`成功同步了 ${syncedLogs.length} 条离线日志`);
                
                // 更新UI显示
                if (syncedLogs.length > 0) {
                    loadLogs(1);
                    updateStats();
                }
            } catch (error) {
                console.error('同步离线日志失败:', error);
            }
        }
        
        // 检查并显示网络状态
        function checkNetworkStatus() {
            const isOnline = navigator.onLine;
            console.log(isOnline ? '网络已连接' : '网络已断开');
            return isOnline;
        }
        
        // 监听在线状态变化
        window.addEventListener('online', () => {
            checkNetworkStatus();
            // 尝试同步离线日志
            syncOfflineLogs();
            
            // 显示在线状态提示
            showToast('网络已恢复，正在同步离线数据...');
        });
        
        window.addEventListener('offline', () => {
            checkNetworkStatus();
            // 显示离线状态提示
            showToast('当前处于离线模式，数据将在网络恢复后同步');
        });
        
        // 初始检查网络状态
        checkNetworkStatus();
        
        // 增强的提示消息函数
        function showToast(message, duration = 3000) {
            // 确保DOM已加载
            if (!document.body) {
                setTimeout(() => showToast(message, duration), 100);
                return;
            }
            
            // 检查是否已存在toast元素
            let toast = document.getElementById('toast-message');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-message';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                toast.style.color = 'white';
                toast.style.padding = '12px 20px';
                toast.style.borderRadius = '20px';
                toast.style.zIndex = '10000';
                toast.style.fontSize = '14px';
                toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                toast.style.transition = 'opacity 0.3s ease';
                document.body.appendChild(toast);
            }
            
            // 重置显示
            toast.style.display = 'block';
            toast.style.opacity = '1';
            toast.textContent = message;
            
            // 清除之前的定时器
            if (toast.timer) {
                clearTimeout(toast.timer);
            }
            
            // 设置新的定时器隐藏
            toast.timer = setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, duration);
        }
        
        // Service Worker注册函数
        function registerServiceWorker() {
            console.log('开始注册Service Worker');
            if ('serviceWorker' in navigator) {
                // 清除之前可能存在的Service Worker
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for(let registration of registrations) {
                        console.log('注销旧的Service Worker:', registration.scope);
                        registration.unregister();
                    }
                    
                    // 重新注册Service Worker
                    setTimeout(() => {
                        navigator.serviceWorker.register('service-worker.js', { scope: '/' })
                            .then(registration => {
                                console.log('Service Worker 注册成功:', registration.scope);
                                
                                // 确保立即控制页面
                                registration.addEventListener('updatefound', () => {
                                    const newWorker = registration.installing;
                                    console.log('发现新的Service Worker版本');
                                    newWorker.addEventListener('statechange', () => {
                                        console.log('Service Worker状态变更:', newWorker.state);
                                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                            console.log('有新版本的Service Worker可用，等待激活');
                                            // 强制激活新版本
                                            if (newWorker.waiting) {
                                                newWorker.waiting.postMessage({ type: 'SKIP_WAITING' });
                                            }
                                        } else if (newWorker.state === 'activated') {
                                            console.log('Service Worker已激活');
                                            // 刷新缓存
                                            registration.active.postMessage({ type: 'REFRESH_CACHE' });
                                        }
                                    });
                                });
                                
                                // 检查后台同步支持并添加更好的错误处理
                                if ('SyncManager' in window && 'sync' in registration) {
                                    console.log('浏览器支持后台同步');
                                    // 尝试同步离线日志，使用Promise链而非async/await避免语法错误
                                    navigator.permissions.query({ name: 'periodic-background-sync' })
                                        .then(permission => permission.state === 'granted')
                                        .catch(() => true) // 如果权限查询失败，仍然尝试注册
                                        .then(canUseSync => {
                                            if (canUseSync) {
                                                return registration.sync.register('sync-logs');
                                            }
                                            return Promise.reject(new Error('权限未授予或被禁用'));
                                        })
                                        .then(() => {
                                            console.log('后台同步已注册');
                                        })
                                        .catch(err => {
                                            console.log('后台同步注册失败或不可用:', err.message || '未知错误');
                                            // 静默处理错误，不影响应用正常运行
                                        });
                                } else {
                                    console.log('浏览器不支持后台同步');
                                }
                                
                                // 如果已经有控制的Service Worker，通知它刷新缓存
                                if (navigator.serviceWorker.controller) {
                                    console.log('发送缓存刷新消息到现有Service Worker');
                                    navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_CACHE' });
                                }
                            })
                            .catch(error => {
                                console.error('Service Worker 注册失败:', error);
                                showToast('离线功能初始化失败');
                                // 显示加载指示器
                                showLoadingIndicator(false);
                            });
                    }, 1000);
                }).catch(err => {
                    console.error('获取Service Worker注册失败:', err);
                });
            } else {
                console.log('浏览器不支持Service Worker');
                showToast('您的浏览器不支持离线功能');
            }
        }
        
        // 显示加载指示器
        function showLoadingIndicator(show) {
            let loader = document.getElementById('loading-indicator');
            if (!loader && show) {
                loader = document.createElement('div');
                loader.id = 'loading-indicator';
                loader.style.position = 'fixed';
                loader.style.top = '0';
                loader.style.left = '0';
                loader.style.width = '100%';
                loader.style.height = '100%';
                loader.style.display = 'flex';
                loader.style.justifyContent = 'center';
                loader.style.alignItems = 'center';
                loader.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                loader.style.zIndex = '9999';
                loader.innerHTML = '<div style="text-align: center;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #6A82FB; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 15px;">加载中...</p></div>';
                
                // 添加旋转动画
                const style = document.createElement('style');
                style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                document.head.appendChild(style);
                
                document.body.appendChild(loader);
            } else if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }
        
        // 显示加载指示器
        function showLoadingIndicator() {
            let loader = document.getElementById('app-loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'app-loader';
                loader.style.position = 'fixed';
                loader.style.top = '0';
                loader.style.left = '0';
                loader.style.width = '100%';
                loader.style.height = '100%';
                loader.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                loader.style.display = 'flex';
                loader.style.alignItems = 'center';
                loader.style.justifyContent = 'center';
                loader.style.zIndex = '9999';
                
                const spinner = document.createElement('div');
                spinner.style.width = '50px';
                spinner.style.height = '50px';
                spinner.style.border = '5px solid #f3f3f3';
                spinner.style.borderTop = '5px solid #6A82FB';
                spinner.style.borderRadius = '50%';
                spinner.style.animation = 'spin 1s linear infinite';
                
                const style = document.createElement('style');
                style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                document.head.appendChild(style);
                
                loader.appendChild(spinner);
                document.body.appendChild(loader);
            }
            loader.style.display = 'flex';
        }
        
        // 隐藏加载指示器
        function hideLoadingIndicator() {
            const loader = document.getElementById('app-loader');
            if (loader) {
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
        }
        
        // 监听Service Worker消息
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data) {
                    switch(event.data.type) {
                        case 'SYNC_COMPLETED':
                            console.log('离线日志同步完成');
                            showToast('数据同步完成');
                            // 同步完成后刷新数据
                            if (currentUser) {
                                loadLogs(1);
                                updateStats();
                            }
                            break;
                        case 'SW_UPDATED':
                            console.log('Service Worker 已更新');
                            showToast('应用已更新');
                            break;
                    }
                }
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
        
        // 添加设备方向变化时重新渲染图表
        window.addEventListener('orientationchange', function() {
            if (userLogs.length > 0) {
                setTimeout(drawChart, 300);
            }
        });
        
        // 监听页面可见性变化，在页面重新可见时刷新数据
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser) {
                loadLogs(1);
                updateStats();
            }
        });
        
        // 监听beforeinstallprompt事件，允许自定义安装提示
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // 阻止Chrome 67及更早版本自动显示安装提示
            e.preventDefault();
            // 保存事件以便稍后触发
            deferredPrompt = e;
            // 可以在这里显示自定义的安装按钮
            console.log('应用可以被安装');
        });
    </script>
</body>
</html>