<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MoodMend">
    <meta name="theme-color" content="#6A82FB">
    <meta name="description" content="MoodMend å¹«åŠ©ä½ è¨˜éŒ„å’Œç®¡ç†æƒ…ç·’ï¼Œæä¾›ä¸ªæ€§åŒ–çš„æƒ…ç·’èª¿æ•´æ–¹æ¡ˆ">
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.svg">
    <link rel="mask-icon" href="icon-192x192.svg" color="#6A82FB">
    <link rel="shortcut icon" href="icon-192x192.svg">
    <!-- é¢„åŠ è½½æ ¸å¿ƒèµ„æº -->
    <title>MoodMend</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* åŸºç¡€é‡ç½®å’ŒAPPæ ·å¼ */
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #6A82FB 0%, #FC5C7D 100%); 
            min-height: 100vh; 
            margin: 0; 
            padding: 0; 
            color: #333;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        /* åŠŸèƒ½èœå•æ ·å¼ */
        .menu-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .menu-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #6A82FB;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(106, 130, 251, 0.4);
            margin: 0;
            padding: 0;
        }
        .menu-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            width: 200px;
            display: none;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .menu-dropdown button {
            width: 100%;
            padding: 16px 20px;
            border: none;
            background: white;
            color: #333;
            text-align: left;
            font-size: 16px;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f0f0f0;
        }
        .menu-dropdown button:last-child {
            border-bottom: none;
        }
        .menu-dropdown button:hover, .menu-dropdown button:active {
            background: #f8f9fa;
            transform: none;
        }
        .menu-dropdown.show {
            display: block;
        }
        .page { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100vh; 
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); 
            box-sizing: border-box; 
            overflow-y: auto;
        }
        .page.active { display: block; }
        .container { 
            width: 100%; 
            max-width: 100%; 
            margin: 0; 
            background: rgba(255,255,255,0.95); 
            border-radius: 0; 
            min-height: 100%; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        h1 { text-align: center; color: #6A82FB; font-size: 24px; margin: 20px 0; }
        input, select { 
            width: 100%; 
            padding: 16px; 
            margin: 12px 0; 
            border: 2px solid #FC5C7D; 
            border-radius: 12px; 
            box-sizing: border-box; 
            font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            appearance: none;
            -webkit-appearance: none;
        }
        button { 
            background: #FC5C7D; 
            color: white; 
            border: none; 
            padding: 16px 24px; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: 600;
            cursor: pointer; 
            transition: transform 0.2s, background-color 0.2s;
            width: 100%; 
            margin: 12px 0; 
            box-shadow: 0 4px 12px rgba(252, 92, 125, 0.3);
        }
        button:hover, button:active { 
            transform: scale(1.02); 
            background-color: #ff4a69; 
        }
        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 20px; 
            margin: 15px 0; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); 
        }
        .emotion-badge { 
            display: inline-block; 
            padding: 8px 16px; 
            border-radius: 25px; 
            color: white; 
            font-weight: bold; 
            margin: 5px; 
            font-size: 14px;
        }
        .anxious { background: #FF6B6B; color: white; } 
        .sad { background: #4ECDC4; color: white; } 
        .neutral { background: #45B7D1; color: white; } 
        .happy { background: #96CEB4; color: white; } 
        .angry { background: #FFEAA7; color: #333; }
        /* To-Do Listæ ·å¼ */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 16px;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        .todo-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .todo-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            cursor: pointer;
            border: 2px solid #6A82FB;
            border-radius: 8px;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
            flex-shrink: 0;
        }
        .todo-checkbox:checked {
            background: #6A82FB;
            border-color: #6A82FB;
        }
        .todo-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .todo-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
            transition: opacity 0.2s ease;
        }
        .todo-checkbox:checked + .todo-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .log-entry { 
            background: #f0f8ff; 
            padding: 16px; 
            border-radius: 16px; 
            margin: 10px 0; 
            line-height: 1.6;
        }
        .filter-bar { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .filter-bar select, .filter-bar input { 
            flex: 1; 
            min-width: 0; 
        }
        #logChart { max-height: 200px; margin: 20px 0; }
        /* åº•éƒ¨å¯¼èˆªæ  - æ¨¡æ‹ŸAPPåº•éƒ¨æ ‡ç­¾æ  */
        .nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            gap: 0; 
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            padding: 12px 0;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        .nav button { 
            flex: 1; 
            margin: 0 8px;
            border-radius: 16px;
            font-size: 14px;
            padding: 14px 10px;
            box-shadow: none;
        }
        .stats { 
            text-align: center; 
            margin: 20px 0; 
            font-weight: bold; 
            color: #6A82FB; 
            font-size: 16px;
            padding: 12px;
            background: rgba(106, 130, 251, 0.1);
            border-radius: 16px;
        }
    </style>
</head>
<body>
    <!-- é 1: ç™»éŒ„ -->
    <div id="page1" class="page active">
        <div class="container">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="icon-moodmend.svg" alt="MoodMend Logo" width="160" height="160" style="max-width: 80%;">
            </div>
            <h1>MoodMend æ­¡è¿</h1>
            <div class="card">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="login()">ç™»éŒ„</button>
                <button onclick="switchPage('pageRegister')" style="background-color: #6A82FB; box-shadow: 0 4px 12px rgba(106, 130, 251, 0.3);">è¨»å†Šæ–°å¸³è™Ÿ</button>
                <p style="text-align: center; font-size: 12px;">Demo: ç”¨ test@test.com / 123 ç™»å…¥</p>
            </div>
        </div>
    </div>
    
    <!-- é 5: è¨»å†Š -->
    <div id="pageRegister" class="page">
        <div class="container">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="icon-moodmend.svg" alt="MoodMend Logo" width="160" height="160" style="max-width: 80%;">
            </div>
            <h1>å‰µå»ºæ–°å¸³è™Ÿ</h1>
            <div class="card">
                <input type="text" id="registerUserName" placeholder="ç”¨æˆ·å (2-20ä¸ªå­—ç¬¦)">
                <input type="email" id="registerEmail" placeholder="Email">
                <input type="password" id="registerPassword" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½)">
                <input type="password" id="confirmPassword" placeholder="ç¢ºèªå¯†ç¢¼">
                <button onclick="register()">è¨»å†Š</button>
                <button onclick="switchPage('page1')" style="background-color: #666; box-shadow: 0 4px 12px rgba(102, 102, 102, 0.3);">è¿”å›ç™»éŒ„</button>
            </div>
        </div>
    </div>

    <!-- é 2: æ­¡è¿é é¢ -->
    <div id="pageWelcome" class="page">
        <div class="container">
            <!-- åŠŸèƒ½èœå• -->
            <div class="menu-container">
                <button id="menuButtonWelcome" class="menu-button" onclick="toggleMenu('menuButtonWelcome')">â˜°</button>
                <div id="menuWelcome" class="menu-dropdown">
                    <button onclick="switchPage('page2')">ğŸ’­ å¿ƒæƒ…è¨˜éŒ„</button>
                    <button onclick="switchPage('page3')">ğŸ“Š æŸ¥çœ‹ç´€éŒ„</button>
                    <button onclick="logout()">ğŸ‘¤ ç™»å‡º</button>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="icon-moodmend.svg" alt="MoodMend Logo" width="120" height="120" style="max-width: 60%;">
            </div>
            <h1>æ­¡è¿ä¾†åˆ° MoodMend</h1>
            <p id="welcomeMessage" class="welcome-message" style="text-align: center; font-size: 18px; color: #6A82FB; margin-bottom: 20px;"></p>
            <div class="card" style="text-align: center; padding: 30px 15px; margin-top: 40px;">
                <p style="font-size: 18px; margin-bottom: 30px; font-weight: 500;">ã€Œæ¯ä¸€ç¨®æƒ…ç·’éƒ½å€¼å¾—è¢«ç†è§£å’Œé—œç…§ã€</p>
                <p style="margin-bottom: 40px; line-height: 1.6; font-size: 16px;">åœ¨é€™è£¡ï¼Œæˆ‘å€‘å°‡ä¸€èµ·æ¢ç´¢ä½ çš„æƒ…ç·’ä¸–ç•Œï¼Œæä¾›å°ˆå±¬çš„èª¿é©æ–¹æ¡ˆï¼Œå¹«åŠ©ä½ åº¦éæ¯ä¸€å€‹å¿ƒæƒ…æ™‚åˆ»ã€‚</p>
                <button onclick="switchPage('page2')" style="margin-top: 20px; font-size: 18px; padding: 16px;">é–‹å§‹èª¿é©ä¹‹æ—…</button>
            </div>
            <div style="text-align: center; margin-top: 40px; padding: 0 20px;">
                <p style="color: #666; font-size: 14px;">ä»Šå¤©ï¼Œä½ æƒ³å¦‚ä½•ç…§é¡§è‡ªå·±çš„å¿ƒæƒ…ï¼Ÿ</p>
            </div>
        </div>
    </div>

    <!-- é 3: ä¸»è¦äº’å‹• -->
    <div id="page2" class="page">
        <div class="container">
            <!-- åŠŸèƒ½èœå• -->
            <div class="menu-container">
                <button id="menuButton2" class="menu-button" onclick="toggleMenu('menuButton2')">â˜°</button>
                <div id="menu2" class="menu-dropdown">
                    <button onclick="switchPage('pageWelcome')">ğŸ  å›åˆ°æ­¡è¿é </button>
                    <button onclick="switchPage('page3')">ğŸ“Š æŸ¥çœ‹ç´€éŒ„</button>
                    <button onclick="logout()">ğŸ‘¤ ç™»å‡º</button>
                </div>
            </div>
            <h1>ä»Šå¤©çš„å¿ƒæƒ…ï¼Ÿ</h1>
            <input type="text" id="emotionInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ„Ÿåˆ°ç„¦æ…®">
            <button onclick="processEmotion()">é–‹å§‹èª¿ç¯€</button>
            <div id="packageCard" class="card" style="display: none;"></div>
            <div style="display: none;" id="taskSection">
                <h3 style="color: #6A82FB; margin-top: 30px; margin-bottom: 20px;">ä»Šå¤©çš„ä»»å‹™</h3>
                <div class="todo-item">
                    <input type="checkbox" id="taskComplete" class="todo-checkbox" onchange="checkCompletion()">
                    <span class="todo-text" id="taskText">æ­£åœ¨åŠ è¼‰ä»»å‹™...</span>
                </div>
                <button onclick="showNFT()" id="nftButton" style="margin-top: 20px;">ç”Ÿæˆå¾½ç« </button>
            </div>
            <!-- ç§»é™¤åº•éƒ¨çš„æŸ¥çœ‹LogæŒ‰é’®ï¼ŒåŠŸèƒ½å·²æ•´åˆåˆ°é¡¶éƒ¨èœå• -->
        </div>
    </div>

    <!-- é 4: Logç´€éŒ„ -->
    <div id="page3" class="page">
        <div class="container">
            <!-- åŠŸèƒ½èœå• -->
            <div class="menu-container">
                <button id="menuButton3" class="menu-button" onclick="toggleMenu('menuButton3')">â˜°</button>
                <div id="menu3" class="menu-dropdown">
                    <button onclick="switchPage('pageWelcome')">ğŸ  å›åˆ°æ­¡è¿é </button>
                    <button onclick="switchPage('page2')">ğŸ’­ å¿ƒæƒ…è¨˜éŒ„</button>
                    <button onclick="logout()">ğŸ‘¤ ç™»å‡º</button>
                </div>
            </div>
            <h1>æˆ‘çš„ç™‚ç™’ç´€éŒ„</h1>
            <div class="filter-bar">
                <select id="emotionFilter" style="flex: 1;">
                    <option value="">æ‰€æœ‰æƒ…ç·’</option>
                    <option value="anxious">ç„¦æ…®</option>
                    <option value="sad">å‚·å¿ƒ</option>
                    <option value="neutral">å¹³éœ</option>
                    <option value="happy">å¿«æ¨‚</option>
                    <option value="angry">ç”Ÿæ°£</option>
                </select>
                <input type="date" id="dateFilter" style="flex: 1;">
                <button onclick="filterLogs()" style="flex-shrink: 0; min-width: 80px;">éæ¿¾</button>
            </div>
            <div class="stats" id="stats">æœ¬é€±å®Œæˆç‡ï¼š0% | è½‰ç§»æˆå°±ï¼š0</div>
            <canvas id="logChart"></canvas>
            <div id="logSection"></div>
            <!-- ç§»é™¤navä¸­çš„è¿”å›äº’å‹•æŒ‰éˆ•ï¼Œåƒ…ç•™ç©ºé–“è‹¥æœªä¾†åŠ æ–°CTA -->
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å®šä¹‰ - ç¡®ä¿åœ¨æ‰€æœ‰ä½¿ç”¨å‰åˆå§‹åŒ–
        window.currentUser = null;
        let currentPackage = null;
        let userLogs = [];
        
        // ä¿®å¤iOS Safariä¸­çŠ¶æ€æ è¦†ç›–é—®é¢˜
        if (/(iPhone|iPad|iPod)/i.test(navigator.userAgent)) {
            document.documentElement.style.paddingTop = env(safe-area-inset-top) + 'px';
        }

        // åŠŸèƒ½èœå•åˆ‡æ¢
        function toggleMenu(buttonId) {
            // å…³é—­æ‰€æœ‰å…¶ä»–èœå•
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // åˆ‡æ¢å½“å‰èœå•
            const button = document.getElementById(buttonId);
            const menuId = buttonId.replace('Button', '');
            const menu = document.getElementById(menuId);
            menu.classList.toggle('show');
        }
        
        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-container')) {
                document.querySelectorAll('.menu-dropdown').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // é é¢åˆ‡æ› - æ·»åŠ å¹³æ»‘è¿‡æ¸¡
        function switchPage(pageId) {
            // å…ˆå…³é—­æ‰€æœ‰èœå•
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(pageId).classList.add('active');
            
            // é‡ç½®æ»šåŠ¨ä½ç½®
            document.getElementById(pageId).scrollTop = 0;
            
            // å¦‚æœæ˜¯æ¬¢è¿é¡µé¢ï¼Œæ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
            if (pageId === 'pageWelcome' && currentUser) {
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (welcomeMessage && currentUser.user_name) {
                    welcomeMessage.textContent = `å—¨ï¼Œ${currentUser.user_name}ï¼`;
                }
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°æ—¥å¿—é¡µï¼ŒåŠ è½½æ•°æ®
            if (pageId === 'page3') {
                loadLogs();
            }
        }

        // æ˜¾ç¤ºåŠ è½½ä¸­ - æ”¹è¿›åŠ è½½åŠ¨ç”»
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div style="text-align: center; padding: 20px; color: #6A82FB;"><div style="display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(106, 130, 251, 0.3); border-radius: 50%; border-top-color: #6A82FB; animation: spin 1s ease-in-out infinite;"></div><p style="margin-top: 10px;">åŠ è¼‰ä¸­...</p></div>';
        }
        
        // æ·»åŠ æ—‹è½¬åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ - ä½¿ç”¨æ›´å‹å¥½çš„æç¤ºæ–¹å¼
        function showError(message) {
            // ç§»åŠ¨ç«¯æ›´å‹å¥½çš„æç¤º
            const errorCard = document.createElement('div');
            errorCard.className = 'card';
            errorCard.style.backgroundColor = '#ffebee';
            errorCard.style.color = '#c62828';
            errorCard.style.position = 'fixed';
            errorCard.style.bottom = '100px';
            errorCard.style.left = '50%';
            errorCard.style.transform = 'translateX(-50%)';
            errorCard.style.zIndex = '1000';
            errorCard.style.padding = '15px 20px';
            errorCard.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';
            errorCard.textContent = 'éŒ¯èª¤ï¼š' + message;
            
            document.body.appendChild(errorCard);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                errorCard.style.opacity = '0';
                errorCard.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(errorCard);
                }, 500);
            }, 3000);
        }

        // ç™»éŒ„
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                return alert('è«‹å¡«å¯«å®Œæ•´çš„ç™»éŒ„è³‡è¨Š');
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loginButton = document.querySelector('#page1 button');
                const originalText = loginButton.textContent;
                loginButton.textContent = 'ç™»éŒ„ä¸­...';
                loginButton.disabled = true;
                
                console.log('æ­£åœ¨å‘é€ç™»å½•è¯·æ±‚:', email);
                const response = await fetch('http://localhost:5000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                console.log('ç™»å½•è¯·æ±‚å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('ç™»å½•å“åº”æ•°æ®:', data);
                
                if (data.success) {
                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
                    window.currentUser = {
                        email: data.email,
                        user_name: data.user_name
                    };
                    localStorage.setItem('user', JSON.stringify(window.currentUser));
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    alert('ç™»éŒ„æˆåŠŸï¼');
                    switchPage('pageWelcome');
                } else {
                    alert(data.message || 'ç™»éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
                }
            } catch (error) {
                console.error('ç™»éŒ„é”™è¯¯:', error);
                showError('ç™»éŒ„å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™å·²å•Ÿå‹•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const loginButton = document.querySelector('#page1 button');
                loginButton.textContent = 'ç™»éŒ„';
                loginButton.disabled = false;
            }
        }
        
        // è¨»å†Š
        async function register() {
            const user_name = document.getElementById('registerUserName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // è¡¨å•éªŒè¯
            if (!email || !password || !user_name) {
                return alert('è«‹å¡«å¯«å®Œæ•´çš„è¨»å†Šè³‡è¨Š');
            }
            
            if (user_name.length < 2 || user_name.length > 20) {
                return alert('ç”¨æˆ·åé•¿åº¦åº”åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´');
            }
            
            if (password.length < 6) {
                return alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½');
            }
            
            if (password !== confirmPassword) {
                return alert('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, user_name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // è¨»å†ŠæˆåŠŸå¾Œè‡ªå‹•ç™»éŒ„
                    currentUser = {
                        email: data.email,
                        user_name: data.user_name
                    };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('registerUserName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    switchPage('pageWelcome');
                } else {
                    alert(data.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                }
            } catch (error) {
                showError('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™å·²å•Ÿå‹•');
            }
        }

        // è™•ç†æƒ…ç·’
        async function processEmotion() {
            const input = document.getElementById('emotionInput').value;
            if (!input) return alert('è«‹è¼¸å…¥');
            
            try {
                const taskCompleted = document.getElementById('taskComplete')?.checked || false;
                
                showLoading('packageCard');
                
                // æ£€æŸ¥ç½‘ç»œè¿æ¥
                if (!navigator.onLine) {
                    // ç¦»çº¿æ¨¡å¼ - æç¤ºç”¨æˆ·
                    showError('å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/process-emotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        input, 
                        email: window.currentUser?.email || window.currentUser,
                        task_completed: taskCompleted
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentPackage = data;
                    const pkg = data.package;
                    
                    document.getElementById('packageCard').innerHTML = `
                        <h3><span class="emotion-badge ${pkg.color}">${data.emotion}</span></h3>
                        <p><strong>æŠ€å·§ï¼š</strong>${pkg.tips}</p>
                        <p><strong>å»ºè­°ï¼š</strong>${pkg.advice}</p>
                        <p><small>${pkg.resources}</small></p>
                    `;
                    // æ›´æ–°ä»»åŠ¡æ–‡æœ¬
                    document.getElementById('taskText').textContent = pkg.daily_task;
                    document.getElementById('packageCard').style.display = 'block';
                    document.getElementById('taskSection').style.display = 'block';
                } else {
                    alert(data.message);
                }
            } catch (error) {
                showError('è™•ç†æƒ…ç·’å¤±æ•—');
            }
        }

        // æ£€æŸ¥ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼Œå¯ç”¨/ç¦ç”¨ç”Ÿæˆå¾½ç« æŒ‰é’®
        function checkCompletion() {
            const completed = document.getElementById('taskComplete').checked;
            const nftButton = document.getElementById('nftButton');
            
            if (completed) {
                nftButton.style.backgroundColor = '#4CAF50';
                nftButton.style.boxShadow = '0 4px 12px rgba(76, 175, 80, 0.3)';
            } else {
                nftButton.style.backgroundColor = '#FC5C7D';
                nftButton.style.boxShadow = '0 4px 12px rgba(252, 92, 125, 0.3)';
            }
        }

        // æ˜¾ç¤ºå¾½ç« å¹¶ä¿å­˜æ—¥å¿—
        async function showNFT() {
            if (!currentPackage) return;
            
            const completed = document.getElementById('taskComplete').checked;
            const badge = currentPackage.nft;
            
            // ç§»åŠ¨ç«¯å‹å¥½çš„æç¤º
            const notification = document.createElement('div');
            notification.className = 'card';
            notification.style.backgroundColor = '#e8f5e9';
            notification.style.color = '#2e7d32';
            notification.style.position = 'fixed';
            notification.style.top = '50%';
            notification.style.left = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.zIndex = '1000';
            notification.style.padding = '20px';
            notification.style.boxShadow = '0 8px 30px rgba(0,0,0,0.3)';
            notification.style.textAlign = 'center';
            notification.innerHTML = `<h3 style="margin-top: 0;">ğŸ† æ­å–œï¼</h3><p style="font-size: 18px; margin-bottom: 20px;">${badge}</p>`;
            
            const okButton = document.createElement('button');
            okButton.textContent = 'å¤ªæ£’äº†ï¼';
            okButton.style.maxWidth = '200px';
            okButton.style.margin = '0 auto';
            okButton.style.display = 'block';
            
            document.body.appendChild(notification);
            notification.appendChild(okButton);
            
            // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¡®è®¤
            await new Promise(resolve => {
                okButton.onclick = () => {
                    document.body.removeChild(notification);
                    resolve();
                };
            });
            
            // å‡†å¤‡æ—¥å¿—æ•°æ®
            const logData = {
                email: window.currentUser?.email || window.currentUser,
                emotion: currentPackage.emotion,
                task: currentPackage.package.daily_task,
                nft: badge,
                completed: completed,
                timestamp: new Date().toISOString()
            };
            
            try {
                // æ£€æŸ¥ç½‘ç»œè¿æ¥
                if (navigator.onLine) {
                    // åœ¨çº¿æ¨¡å¼ - ç›´æ¥ä¿å­˜åˆ°æœåŠ¡å™¨
                    const response = await fetch('http://localhost:5000/api/add-log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(logData)
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        // ä¿å­˜å¤±è´¥ï¼Œå°è¯•ä¿å­˜åˆ°æœ¬åœ°
                        saveLogToOffline(logData);
                        showError('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œè®°å½•å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚');
                    }
                } else {
                    // ç¦»çº¿æ¨¡å¼ - ä¿å­˜åˆ°æœ¬åœ°
                    saveLogToOffline(logData);
                    showError('å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œè®°å½•å·²ä¿å­˜ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥ã€‚');
                    
                    // æ³¨å†Œåå°åŒæ­¥
                    if ('serviceWorker' in navigator && 'SyncManager' in window) {
                        const sw = await navigator.serviceWorker.ready;
                        try {
                            await sw.sync.register('sync-logs');
                        } catch (err) {
                            console.error('åå°åŒæ­¥æ³¨å†Œå¤±è´¥:', err);
                        }
                    }
                }
                
                // é‡ç½®ç•Œé¢
                document.getElementById('emotionInput').value = '';
                document.getElementById('taskComplete').checked = false;
                document.getElementById('taskText').textContent = 'æ­£åœ¨åŠ è¼‰ä»»å‹™...';
                const nftButton = document.getElementById('nftButton');
                nftButton.style.backgroundColor = '#FC5C7D';
                nftButton.style.boxShadow = '0 4px 12px rgba(252, 92, 125, 0.3)';
                document.getElementById('packageCard').style.display = 'none';
                document.getElementById('taskSection').style.display = 'none';
                currentPackage = null;
                
                switchPage('page3');
            } catch (error) {
                // ä¿å­˜å¤±è´¥ï¼Œå°è¯•ä¿å­˜åˆ°æœ¬åœ°
                saveLogToOffline(logData);
                showError('ä¿å­˜æ—¥èªŒå¤±æ•—ï¼Œå·²å°è¯•ä¿å­˜åˆ°æœ¬åœ°ã€‚');
            }
        }

        // åŠ è¼‰æ—¥èªŒ
        async function loadLogs(page = 1) {
            try {
                showLoading('logSection');
                
                const emotionFilter = document.getElementById('emotionFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;
                const limit = 50; // æ¯é¡µæ˜¾ç¤º50æ¡è®°å½•
                const offset = (page - 1) * limit; // è®¡ç®—åç§»é‡
                
                let url = `http://localhost:5000/api/get-logs?email=${encodeURIComponent(window.currentUser?.email || window.currentUser)}&limit=${limit}&offset=${offset}`;
                if (emotionFilter) url += `&emotion=${encodeURIComponent(emotionFilter)}`;
                if (dateFilter) url += `&date=${encodeURIComponent(dateFilter)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    userLogs = data.logs;
                    const totalPages = Math.ceil(data.total / limit);
                    renderLogs(totalPages, page, data.total);
                    updateStats();
                }
            } catch (error) {
                showError('åŠ è¼‰æ—¥èªŒå¤±æ•—');
            }
        }

        // æ¸²æŸ“æ—¥èªŒ
        function renderLogs(totalPages, currentPage, totalLogs) {
            const section = document.getElementById('logSection');
            section.innerHTML = '';
            
            // æ˜¾ç¤ºæ—¥å¿—æ€»æ•°
            const logCount = document.createElement('div');
            logCount.className = 'log-count';
            logCount.innerHTML = `<p style="text-align: center; color: #666; margin-bottom: 15px;">å…± ${totalLogs} æ¢è¨˜éŒ„</p>`;
            section.appendChild(logCount);
            
            if (userLogs.length === 0) {
                section.innerHTML += '<p style="text-align: center; color: #666;">æ­¤é é¢æ²’æœ‰è¨˜éŒ„</p>';
            } else {
                // æŒ‰æ™‚é–“å€’åºæ’åˆ—
                userLogs.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                userLogs.forEach(log => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    
                    // æƒ…ç·’é¡è‰²æ˜ å°„
                    const emotionColors = {
                        'anxious': 'anxious',
                        'sad': 'sad',
                        'neutral': 'neutral',
                        'happy': 'happy',
                        'angry': 'angry'
                    };
                    
                    const colorClass = emotionColors[log.emotion] || 'neutral';
                    
                    entry.innerHTML = `
                        <strong>${log.time}:</strong> <span class="emotion-badge ${colorClass}">${log.emotion}</span>
                        | ä»»å‹™: ${log.task} ${log.completed ? 'âœ…' : ''} | å¾½ç« : ${log.nft}
                    `;
                    section.appendChild(entry);
                });
                
                drawChart();
            }
            
            // æ·»åŠ åˆ†é¡µæ§ä»¶
            if (totalPages > 1) {
                const pagination = document.createElement('div');
                pagination.className = 'pagination';
                pagination.style.textAlign = 'center';
                pagination.style.marginTop = '20px';
                
                // ä¸Šä¸€é¡µæŒ‰é’®
                const prevButton = document.createElement('button');
                prevButton.textContent = 'ä¸Šä¸€é ';
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => loadLogs(currentPage - 1);
                prevButton.className = 'btn';
                prevButton.style.marginRight = '10px';
                
                // é¡µç æ˜¾ç¤º
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
                pageInfo.style.margin = '0 15px';
                pageInfo.style.lineHeight = '36px';
                
                // ä¸‹ä¸€é¡µæŒ‰é’®
                const nextButton = document.createElement('button');
                nextButton.textContent = 'ä¸‹ä¸€é ';
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = () => loadLogs(currentPage + 1);
                nextButton.className = 'btn';
                nextButton.style.marginLeft = '10px';
                
                pagination.appendChild(prevButton);
                pagination.appendChild(pageInfo);
                pagination.appendChild(nextButton);
                section.appendChild(pagination);
            }
        }

        // éæ¿¾æ—¥èªŒ
        function filterLogs() {
            loadLogs(1); // è¿‡æ»¤æ—¶é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        async function updateStats() {
            try {
                // é¦–å…ˆæ£€æŸ¥ç½‘ç»œçŠ¶æ€
                if (!navigator.onLine) {
                    // ç¦»çº¿æ¨¡å¼ï¼šå°è¯•ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„ç»Ÿè®¡æ•°æ®
                    const cachedStats = localStorage.getItem('cached_stats');
                    if (cachedStats) {
                        document.getElementById('stats').innerText = cachedStats;
                    } else {
                        document.getElementById('stats').innerText = 'é›¢ç·šæ¨¡å¼ï¼šç„¡æ³•æ›´æ–°çµ±è¨ˆ';
                    }
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/get-stats?email=${encodeURIComponent(window.currentUser?.email || window.currentUser)}`);
                const data = await response.json();
                
                if (data.success) {
                    const statsText = `å®Œæˆç‡ï¼š${data.completion_rate}% | è½‰ç§»æˆå°±ï¼š${data.transitions}`;
                    document.getElementById('stats').innerText = statsText;
                    // ç¼“å­˜ç»Ÿè®¡æ•°æ®ç”¨äºç¦»çº¿æŸ¥çœ‹
                    localStorage.setItem('cached_stats', statsText);
                } else if (data.offline) {
                    // æ˜¾ç¤ºç¦»çº¿æç¤º
                    document.getElementById('stats').innerText = 'é›¢ç·šæ¨¡å¼ï¼šç„¡æ³•æ›´æ–°çµ±è¨ˆ';
                }
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
                // é”™è¯¯æ—¶å°è¯•ä½¿ç”¨ç¼“å­˜æˆ–æ˜¾ç¤ºç¦»çº¿æ¶ˆæ¯
                const cachedStats = localStorage.getItem('cached_stats');
                document.getElementById('stats').innerText = cachedStats || 'é›¢ç·šæ¨¡å¼ï¼šç„¡æ³•æ›´æ–°çµ±è¨ˆ';
            }
        }

        // ç»˜åˆ¶å›¾è¡¨ - ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º
        function drawChart() {
            const ctx = document.getElementById('logChart').getContext('2d');
            
            // é”€æ¯æ—§å›¾è¡¨
            if (window.emotionChart) {
                window.emotionChart.destroy();
            }
            
            // è®¡ç®—æƒ…ç»ªåˆ†å¸ƒ
            const emotionCounts = {
                'anxious': 0,
                'sad': 0,
                'neutral': 0,
                'happy': 0,
                'angry': 0
            };
            
            userLogs.forEach(log => {
                if (emotionCounts.hasOwnProperty(log.emotion)) {
                    emotionCounts[log.emotion]++;
                }
            });
            
            // åˆ›å»ºå›¾è¡¨ - ä¼˜åŒ–ç§»åŠ¨ç«¯äº¤äº’
            window.emotionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ç„¦æ…®', 'å‚·å¿ƒ', 'å¹³éœ', 'å¿«æ¨‚', 'ç”Ÿæ°£'],
                    datasets: [{
                        data: [
                            emotionCounts.anxious,
                            emotionCounts.sad,
                            emotionCounts.neutral,
                            emotionCounts.happy,
                            emotionCounts.angry
                        ],
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value}æ¬¡ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ– - æ·»åŠ æ›´å¤šç§»åŠ¨ç«¯é€‚é…å’ŒPWAæ”¯æŒ
        function init() {
            console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨ - å¢å¼ºPWAæ”¯æŒ');
            
            // ç¦ç”¨iOSåŒå‡»ç¼©æ”¾
            document.addEventListener('touchstart', function preventZoom(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // å­˜å‚¨åˆå§‹è§¦æ‘¸ä½ç½®ä»¥æ£€æµ‹åŒå‡»
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function preventDoubleTapZoom(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showLoadingIndicator();
            
            // æ¸…é™¤æ—§çš„Service Workerç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if ('caches' in window) {
                console.log('å°è¯•æ¸…é™¤æ—§ç¼“å­˜...');
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        if (cacheName.startsWith('moodmend-') && !cacheName.includes('v3')) {
                            console.log('åˆ é™¤æ—§ç¼“å­˜:', cacheName);
                            caches.delete(cacheName);
                        }
                    });
                });
            }
            
            // ç«‹å³æ³¨å†ŒService Workerï¼Œä¸å†ç­‰å¾…loadäº‹ä»¶
            registerServiceWorker();
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œç¡®ä¿åœ¨é¡µé¢é‡æ–°å¯è§æ—¶æ›´æ–°æ•°æ®
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œæ£€æŸ¥æ›´æ–°...');
                    // å¦‚æœå·²ç™»å½•ï¼Œåˆ·æ–°æ•°æ®
                    if (window.currentUser) {
                        loadLogs(1);
                        updateStats();
                    }
                }
            });
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                console.log('æ£€æµ‹åˆ°å·²ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯');
                try {
                    // å°è¯•è§£æç”¨æˆ·å¯¹è±¡
                    window.currentUser = JSON.parse(savedUser);
                } catch (e) {
                    // å…¼å®¹æ—§çš„å­˜å‚¨æ–¹å¼
                    window.currentUser = {
                        email: savedUser,
                        user_name: 'ç”¨æˆ·'
                    };
                    console.error('ç”¨æˆ·æ•°æ®æ ¼å¼ä¸åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤å€¼:', e);
                }
                console.log('ç”¨æˆ·ä¿¡æ¯:', window.currentUser);
                
                // å»¶è¿Ÿåˆ‡æ¢é¡µé¢ï¼Œç¡®ä¿Service Workeræœ‰æ—¶é—´åˆå§‹åŒ–
                setTimeout(() => {
                    switchPage('pageWelcome');
                    // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿é¡µé¢å·²æ¸²æŸ“
                    setTimeout(() => {
                        console.log('å¼€å§‹åŠ è½½ç”¨æˆ·æ•°æ®...');
                        loadLogs(1);
                        updateStats();
                        hideLoadingIndicator();
                    }, 500);
                }, 500);
            } else {
                console.log('æœªæ£€æµ‹åˆ°ç”¨æˆ·ç™»å½•ä¿¡æ¯');
                hideLoadingIndicator();
            }
            
            // åˆå§‹åŒ–å®Œæˆåï¼Œæ£€æŸ¥é¡µé¢æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
            setTimeout(() => {
                console.log('åˆå§‹åŒ–å®Œæˆï¼Œæ£€æŸ¥é¡µé¢çŠ¶æ€...');
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    console.log('å½“å‰æ¿€æ´»é¡µé¢:', activePage.id, 'ï¼ŒçŠ¶æ€æ­£å¸¸');
                } else {
                    console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                }
            }, 2000);
        }

        // ç™»å‡ºå‡½æ•°
        function logout() {
            // æ¸…é™¤localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯
            localStorage.removeItem('user');
            
            // é‡ç½®ç”¨æˆ·ç›¸å…³å˜é‡
            window.currentUser = null;
            currentPackage = null;
            userLogs = [];
            
            // è¿”å›åˆ°ç™»å½•é¡µé¢
            switchPage('page1');
            
            // æ˜¾ç¤ºç™»å‡ºæˆåŠŸæç¤º
            alert('ç™»å‡ºæˆåŠŸ');
        }

        // ä¿å­˜æ—¥å¿—åˆ°ç¦»çº¿å­˜å‚¨
        function saveLogToOffline(logData) {
            try {
                let offlineLogs = JSON.parse(localStorage.getItem('offline_logs') || '[]');
                offlineLogs.push(logData);
                localStorage.setItem('offline_logs', JSON.stringify(offlineLogs));
                console.log('æ—¥å¿—å·²ä¿å­˜åˆ°ç¦»çº¿å­˜å‚¨');
            } catch (error) {
                console.error('ä¿å­˜ç¦»çº¿æ—¥å¿—å¤±è´¥:', error);
            }
        }
        
        // åŒæ­¥ç¦»çº¿æ—¥å¿—åˆ°æœåŠ¡å™¨
        async function syncOfflineLogs() {
            try {
                // ç¡®ä¿åœ¨çº¿çŠ¶æ€
                if (!navigator.onLine) {
                    console.log('å½“å‰ç¦»çº¿ï¼Œæ— æ³•åŒæ­¥æ—¥å¿—');
                    return;
                }
                
                let offlineLogs = JSON.parse(localStorage.getItem('offline_logs') || '[]');
                
                if (offlineLogs.length === 0) return;
                
                // è¿‡æ»¤å‡ºå½“å‰ç”¨æˆ·çš„æ—¥å¿—
                const userEmail = window.currentUser?.email || window.currentUser;
                const userLogs = offlineLogs.filter(log => log.email === userEmail);
                
                if (userLogs.length === 0) return;
                
                // å°è¯•åŒæ­¥æ¯æ¡æ—¥å¿—
                const syncedLogs = [];
                
                for (const log of userLogs) {
                    try {
                        const response = await fetch('http://localhost:5000/api/add-log', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(log)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            syncedLogs.push(log);
                        }
                    } catch (error) {
                        console.error('åŒæ­¥å•æ¡æ—¥å¿—å¤±è´¥:', error);
                    }
                }
                
                // ä»ç¦»çº¿å­˜å‚¨ä¸­ç§»é™¤å·²åŒæ­¥çš„æ—¥å¿—
                const remainingLogs = offlineLogs.filter(log => 
                    !syncedLogs.some(synced => 
                        synced.email === log.email && 
                        synced.timestamp === log.timestamp
                    )
                );
                
                localStorage.setItem('offline_logs', JSON.stringify(remainingLogs));
                
                // é€šçŸ¥Service WorkeråŒæ­¥å®Œæˆ
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SYNC_COMPLETED',
                        data: { synced: syncedLogs.length }
                    });
                }
                
                console.log(`æˆåŠŸåŒæ­¥äº† ${syncedLogs.length} æ¡ç¦»çº¿æ—¥å¿—`);
                
                // æ›´æ–°UIæ˜¾ç¤º
                if (syncedLogs.length > 0) {
                    loadLogs(1);
                    updateStats();
                }
            } catch (error) {
                console.error('åŒæ­¥ç¦»çº¿æ—¥å¿—å¤±è´¥:', error);
            }
        }
        
        // æ£€æŸ¥å¹¶æ˜¾ç¤ºç½‘ç»œçŠ¶æ€
        function checkNetworkStatus() {
            const isOnline = navigator.onLine;
            console.log(isOnline ? 'ç½‘ç»œå·²è¿æ¥' : 'ç½‘ç»œå·²æ–­å¼€');
            return isOnline;
        }
        
        // ç›‘å¬åœ¨çº¿çŠ¶æ€å˜åŒ–
        window.addEventListener('online', () => {
            checkNetworkStatus();
            // å°è¯•åŒæ­¥ç¦»çº¿æ—¥å¿—
            syncOfflineLogs();
            
            // æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€æç¤º
            showToast('ç½‘ç»œå·²æ¢å¤ï¼Œæ­£åœ¨åŒæ­¥ç¦»çº¿æ•°æ®...');
        });
        
        window.addEventListener('offline', () => {
            checkNetworkStatus();
            // æ˜¾ç¤ºç¦»çº¿çŠ¶æ€æç¤º
            showToast('å½“å‰å¤„äºç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥');
        });
        
        // åˆå§‹æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        checkNetworkStatus();
        
        // å¢å¼ºçš„æç¤ºæ¶ˆæ¯å‡½æ•°
        function showToast(message, duration = 3000) {
            // ç¡®ä¿DOMå·²åŠ è½½
            if (!document.body) {
                setTimeout(() => showToast(message, duration), 100);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå…ƒç´ 
            let toast = document.getElementById('toast-message');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-message';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                toast.style.color = 'white';
                toast.style.padding = '12px 20px';
                toast.style.borderRadius = '20px';
                toast.style.zIndex = '10000';
                toast.style.fontSize = '14px';
                toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                toast.style.transition = 'opacity 0.3s ease';
                document.body.appendChild(toast);
            }
            
            // é‡ç½®æ˜¾ç¤º
            toast.style.display = 'block';
            toast.style.opacity = '1';
            toast.textContent = message;
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (toast.timer) {
                clearTimeout(toast.timer);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨éšè—
            toast.timer = setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, duration);
        }
        
        // Service Workeræ³¨å†Œå‡½æ•°
        function registerServiceWorker() {
            console.log('å¼€å§‹æ³¨å†ŒService Worker');
            if ('serviceWorker' in navigator) {
                // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„Service Worker
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for(let registration of registrations) {
                        console.log('æ³¨é”€æ—§çš„Service Worker:', registration.scope);
                        registration.unregister();
                    }
                    
                    // é‡æ–°æ³¨å†ŒService Worker
                    setTimeout(() => {
                        navigator.serviceWorker.register('service-worker.js', { scope: '/' })
                            .then(registration => {
                                console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                                
                                // ç¡®ä¿ç«‹å³æ§åˆ¶é¡µé¢
                                registration.addEventListener('updatefound', () => {
                                    const newWorker = registration.installing;
                                    console.log('å‘ç°æ–°çš„Service Workerç‰ˆæœ¬');
                                    newWorker.addEventListener('statechange', () => {
                                        console.log('Service WorkerçŠ¶æ€å˜æ›´:', newWorker.state);
                                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                            console.log('æœ‰æ–°ç‰ˆæœ¬çš„Service Workerå¯ç”¨ï¼Œç­‰å¾…æ¿€æ´»');
                                            // å¼ºåˆ¶æ¿€æ´»æ–°ç‰ˆæœ¬
                                            if (newWorker.waiting) {
                                                newWorker.waiting.postMessage({ type: 'SKIP_WAITING' });
                                            }
                                        } else if (newWorker.state === 'activated') {
                                            console.log('Service Workerå·²æ¿€æ´»');
                                            // åˆ·æ–°ç¼“å­˜
                                            registration.active.postMessage({ type: 'REFRESH_CACHE' });
                                        }
                                    });
                                });
                                
                                // æ£€æŸ¥åå°åŒæ­¥æ”¯æŒå¹¶æ·»åŠ æ›´å¥½çš„é”™è¯¯å¤„ç†
                                if ('SyncManager' in window && 'sync' in registration) {
                                    console.log('æµè§ˆå™¨æ”¯æŒåå°åŒæ­¥');
                                    // å°è¯•åŒæ­¥ç¦»çº¿æ—¥å¿—ï¼Œä½¿ç”¨Promiseé“¾è€Œéasync/awaité¿å…è¯­æ³•é”™è¯¯
                                    navigator.permissions.query({ name: 'periodic-background-sync' })
                                        .then(permission => permission.state === 'granted')
                                        .catch(() => true) // å¦‚æœæƒé™æŸ¥è¯¢å¤±è´¥ï¼Œä»ç„¶å°è¯•æ³¨å†Œ
                                        .then(canUseSync => {
                                            if (canUseSync) {
                                                return registration.sync.register('sync-logs');
                                            }
                                            return Promise.reject(new Error('æƒé™æœªæˆäºˆæˆ–è¢«ç¦ç”¨'));
                                        })
                                        .then(() => {
                                            console.log('åå°åŒæ­¥å·²æ³¨å†Œ');
                                        })
                                        .catch(err => {
                                            console.log('åå°åŒæ­¥æ³¨å†Œå¤±è´¥æˆ–ä¸å¯ç”¨:', err.message || 'æœªçŸ¥é”™è¯¯');
                                            // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œ
                                        });
                                } else {
                                    console.log('æµè§ˆå™¨ä¸æ”¯æŒåå°åŒæ­¥');
                                }
                                
                                // å¦‚æœå·²ç»æœ‰æ§åˆ¶çš„Service Workerï¼Œé€šçŸ¥å®ƒåˆ·æ–°ç¼“å­˜
                                if (navigator.serviceWorker.controller) {
                                    console.log('å‘é€ç¼“å­˜åˆ·æ–°æ¶ˆæ¯åˆ°ç°æœ‰Service Worker');
                                    navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_CACHE' });
                                }
                            })
                            .catch(error => {
                                console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
                                showToast('ç¦»çº¿åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥');
                                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                                showLoadingIndicator(false);
                            });
                    }, 1000);
                }).catch(err => {
                    console.error('è·å–Service Workeræ³¨å†Œå¤±è´¥:', err);
                });
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒService Worker');
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç¦»çº¿åŠŸèƒ½');
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator(show) {
            let loader = document.getElementById('loading-indicator');
            if (!loader && show) {
                loader = document.createElement('div');
                loader.id = 'loading-indicator';
                loader.style.position = 'fixed';
                loader.style.top = '0';
                loader.style.left = '0';
                loader.style.width = '100%';
                loader.style.height = '100%';
                loader.style.display = 'flex';
                loader.style.justifyContent = 'center';
                loader.style.alignItems = 'center';
                loader.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                loader.style.zIndex = '9999';
                loader.innerHTML = '<div style="text-align: center;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #6A82FB; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 15px;">åŠ è½½ä¸­...</p></div>';
                
                // æ·»åŠ æ—‹è½¬åŠ¨ç”»
                const style = document.createElement('style');
                style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                document.head.appendChild(style);
                
                document.body.appendChild(loader);
            } else if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator() {
            let loader = document.getElementById('app-loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'app-loader';
                loader.style.position = 'fixed';
                loader.style.top = '0';
                loader.style.left = '0';
                loader.style.width = '100%';
                loader.style.height = '100%';
                loader.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                loader.style.display = 'flex';
                loader.style.alignItems = 'center';
                loader.style.justifyContent = 'center';
                loader.style.zIndex = '9999';
                
                const spinner = document.createElement('div');
                spinner.style.width = '50px';
                spinner.style.height = '50px';
                spinner.style.border = '5px solid #f3f3f3';
                spinner.style.borderTop = '5px solid #6A82FB';
                spinner.style.borderRadius = '50%';
                spinner.style.animation = 'spin 1s linear infinite';
                
                const style = document.createElement('style');
                style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                document.head.appendChild(style);
                
                loader.appendChild(spinner);
                document.body.appendChild(loader);
            }
            loader.style.display = 'flex';
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            const loader = document.getElementById('app-loader');
            if (loader) {
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
        }
        
        // ç›‘å¬Service Workeræ¶ˆæ¯
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data) {
                    switch(event.data.type) {
                        case 'SYNC_COMPLETED':
                            console.log('ç¦»çº¿æ—¥å¿—åŒæ­¥å®Œæˆ');
                            showToast('æ•°æ®åŒæ­¥å®Œæˆ');
                            // åŒæ­¥å®Œæˆååˆ·æ–°æ•°æ®
                            if (currentUser) {
                                loadLogs(1);
                                updateStats();
                            }
                            break;
                        case 'SW_UPDATED':
                            console.log('Service Worker å·²æ›´æ–°');
                            showToast('åº”ç”¨å·²æ›´æ–°');
                            break;
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
        
        // æ·»åŠ è®¾å¤‡æ–¹å‘å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“å›¾è¡¨
        window.addEventListener('orientationchange', function() {
            if (userLogs.length > 0) {
                setTimeout(drawChart, 300);
            }
        });
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œåœ¨é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser) {
                loadLogs(1);
                updateStats();
            }
        });
        
        // ç›‘å¬beforeinstallpromptäº‹ä»¶ï¼Œå…è®¸è‡ªå®šä¹‰å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // é˜»æ­¢Chrome 67åŠæ›´æ—©ç‰ˆæœ¬è‡ªåŠ¨æ˜¾ç¤ºå®‰è£…æç¤º
            e.preventDefault();
            // ä¿å­˜äº‹ä»¶ä»¥ä¾¿ç¨åè§¦å‘
            deferredPrompt = e;
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’®
            console.log('åº”ç”¨å¯ä»¥è¢«å®‰è£…');
        });
    </script>
</body>
</html>